{% extends 'layouts/base.html' %}

{% block title %} Table {% endblock title %}

<!-- Specific CSS goes HERE -->
{% block stylesheets %}{% endblock stylesheets %}

{% block content %}

    <!-- Header -->
    <!-- <div class="header bg-gradient-primary pb-8 pt-5 pt-md-8"> -->
	
	<!-- <section style= "height:500px;"> -->
		
	<!--<canvas id="potreecanvas" style="background: gray;left: 0px;position: absolute; z-index: -1;cursor: grab;tabindex=0; border:1px solid;">-->
	<!--</canvas>-->
	<div class="control small" >
		<div class ="text-center ">CONTROL</div>
		<div id = "controlInputs">
			<select class="custom-select-sm" id="day" data-size="4">
				<option>1</option>
				<option>2</option>
				<option>3</option>
				<option>4</option>
			</select>
			<div class ="bimdiv">
				<label class="switch">
					<input type="checkbox" id ="bim" checked>
					<span class="slider round"></span>
				  </label>
				  <label>BIM</label>
			</div>
			<div>
				<label class="switch">
					<input type="checkbox">
					<span class="slider round"></span>
				  </label>
				  <label>Image</label>
			</div>
			<div>
				<label class="switch">
					<input type="checkbox">
					<span class="slider round"></span>
				  </label>
				  <label>UV / Laser</label>
			</div> 
		</div>
	</div>

	<div id="potreeContainer">
		<canvas id="potreecanvasTable"></canvas>
	</div>
	<div id="chart_wrapper">
		<div class="gantt-target"></div>
		<!-- <div id="chart_div">Grantt Chart will be loaded here...</div> -->
	</div>
	<div id = "scheduleInTable" class ="small">
		<span>SCHEDULE</span>
		<div style="background-color: #000000 !important; border-radius: 5px;">
			<input id="timeline" type="range" style="transform: translateX(0%); width: 100%" value="0">
		</div>
	</div>

	<div class="information small">
		<div class ="text-center">INFORMATION</div>
		<div id = "controlInputs">
			<div>
				<label>Frame rate:</label>
				<span id ="frameRate"></span>
			</div>
			<div>
				<label>Points rendered:</label>
			</div>
		</div>
	</div>

{% load static %}
	<script src="/static/assets/js/frappe-gantt.js"></script>
	<script type="module">
		import '/static/assets/fbx/three.js';
		import '/static/assets/fbx/three.module.js';
		import '/static/assets/potree/three.min.js';
		//import '/static/assets/potree/OrbitControls.js';
		import * as OC from '/static/assets/fbx/OrbitControls.js';
		import '/static/assets/potree/potree.js';
		var scene;
		let elementIdTypeMapList = [];
		var tasks = [];
		

		document.body.onload = function()
			{
				scene = new THREE.Scene();
				var canvas = document.getElementById("potreecanvasTable");
				var timeline = document.getElementById("timeline");
				var width = canvas.width;
				var height = canvas.height;

				var camera = new THREE.PerspectiveCamera(60, width / height, 0.1, 1000);
				camera.position.set(-180, 120, -150);

				var renderer = new THREE.WebGLRenderer(
				{
					canvas: canvas,
					alpha: true,
					logarithmicDepthBuffer: true,
					context: null,
					precision: "highp",
					premultipliedAlpha: true,
					antialias: true,
					preserveDrawingBuffer: false,
					powerPreference: "high-performance"
				});
				renderer.sortObjects = false;
				scene.add(new THREE.AmbientLight(0x222222,5));

				var controls = new OC.OrbitControls(camera, canvas);
				controls.autoRotate = false;
				controls.update();

				Potree.Global.workerPath = "./static/assets/source";
				
				var counter = 1;
				
				function loadPointCloud(url, position)
				{

					Potree.loadPointCloud(url, "pointcloud", function(e)
					{
						var points = new Potree.Group();
						points.setPointBudget(500000);
						points.name = "objectName" + String(counter);
						points.material.opacity = 1;
						points.material.wireframe = true;
						points.material.wireframeLinewidth = 0.01;
						scene.add(points);
	
						var pointcloud = e.pointcloud;

						if(position !== undefined)
						{
							pointcloud.position.copy(position);
						}

						points.add(pointcloud);
					});
				}

				function drawChart(){
					if(tasks.length === 0 ) return;
					var gantt_chart = new Gantt(".gantt-target", tasks, {
						on_click: function (task) {
							console.log(task);
						},
						on_date_change: function(task, start, end) {
							console.log(task, start, end);
						},
						on_progress_change: function(task, progress) {
							console.log(task, progress);
						},
						on_view_change: function(mode) {
							console.log(mode);
						},
						view_mode: 'Week',
						language: 'en',
					});
					console.log(gantt_chart);
				}
				function populateElements(mainObj) {
					mainObj.traverse(function (child) {
						if (child.isMesh) {
							if (child.uuid != null && child.name != null) {
								tasks.push({
									'start': '2018-10-08',
									'end': '2018-10-30',
									'name': child.uuid,
									'id': child.uuid,
									'progress': 70
								});
							}
						}
					});
				}

				const light = new THREE.AmbientLight( 0x404040 ); // soft white light
				scene.add( light );

				var lastTime = ( performance || Date ).now();
				var count = 0;
				function fpsUpdate() { 
					var currentTime = ( performance || Date ).now();
					// currentTime - lastTime is the number of milliseconds passed from last loop 
					var fps = 1000 / (currentTime - lastTime);
					lastTime = currentTime;
					count += 1;
					if(count == 30){
						count = 0;
						document.getElementById("frameRate").textContent = fps.toFixed(0);
					}
				}
				var oldVal = 0;
				var elemenCount = 0;
				function timelineValChange(){
					if (scene.getObjectByName('BIM') === undefined) return;	
					if(timeline.value <=25){
						if(oldVal < 25){
							oldVal = timeline.value;
							return;
						}
						scene.getObjectByName('BIM').traverse(function (node) {
							if(node.isMesh){
								node.material = new THREE.MeshBasicMaterial({color: "white"}); 
								node.material.transparent = true;
                                node.material.opacity = 0.4;
                            }
                        });
					}
					else if(timeline.value>25 && timeline.value<=50){
						if(oldVal > 25 && oldVal <= 50){
							oldVal = timeline.value;
							return;
						}
						scene.getObjectByName('BIM').traverse(function (node) {
							if(node.isMesh){
								node.material = new THREE.MeshBasicMaterial({color: "red"});
								node.material.transparent = true;
                                node.material.opacity = 0.4;
                            }
                        });
					}
					else if(timeline.value>50 && timeline.value<=75){
						if(oldVal > 50 && oldVal <= 75){
							oldVal = timeline.value;
							return;
						}
						scene.getObjectByName('BIM').traverse(function (node) {
							if(node.isMesh){
								node.material = new THREE.MeshBasicMaterial({color: "green"});
								node.material.transparent = true;
                                node.material.opacity = 0.4;
								//node.material.depthTest = false;	 
                            }
                        });
					}
					else if(timeline.value>75 && timeline.value<=100){
						if(oldVal > 75 && oldVal <= 100){
							oldVal = timeline.value;
							return;
						}
						scene.getObjectByName('BIM').traverse(function (node) {
							if(node.isMesh){
                                node.material = new THREE.MeshBasicMaterial({color: "White"});
                            }
                        });
					}
					oldVal = timeline.value;
				}

				// timeline.addEventListener("input", function () {
				// 	timelineValChange();
				// });

				//var previous_value = -1;
				var count1 = 0;
				var count2 = 0;
				var count3 = 0;
				function loop()
				{
					if(timeline.value<=34){
						count3 = 0
						count2 = 0;
						count1 = count1 + 1;
						if(count1 == 1){
							var object = scene.getObjectByName("objectName" + String(counter));
							scene.remove(object);
							loadPointCloud("https://mojtaba1995.github.io/clouds/cloud1/cloud.js", new THREE.Vector3(-198, -154, -16));
						}
					}
					if(timeline.value>34 && timeline.value<=67){
						count3 = 0
						count1 = 0;
						count2 = count2 + 1;
						if(count2 == 1){
							var object = scene.getObjectByName("objectName" + String(counter));
							scene.remove(object); 
							loadPointCloud("https://mojtaba1995.github.io//clouds/cloud2/cloud.js", new THREE.Vector3(-210, -150, -17));
						}
						//
					}
					if(timeline.value>67){
						count1 = 0;
						count2 = 0
						count3 = count3 + 1;
						if(count3 == 1){
							var object = scene.getObjectByName("objectName" + String(counter));
							scene.remove(object); 
							loadPointCloud("https://mojtaba1995.github.io//clouds/cloud3/cloud.js", new THREE.Vector3(-196.6, -159, -24));
						}
						//
					}
					timelineValChange();
					controls.update();
					renderer.render(scene, camera);
					fpsUpdate();
					requestAnimationFrame(loop);
				};
				loop();
				const loader = new THREE.ObjectLoader();
				loader.load(
					// resource URL
					"/static/assets/fbx/scene.json",

					// onLoad callback
					// Here the loaded data is assumed to be an object
					function ( obj ) {
						// Add the loaded object to the scene
						obj.position.set(-180, -100, 120);
						obj.name = "BIM";
						obj.renderOrder = 10;
						obj.traverse((node)=>{
                            if(node.isMesh){
                                node.material = new THREE.MeshBasicMaterial({color: "white"});
                                node.material.transparent = true;
                                node.material.opacity = 0.4;
								node.material.depthTest = false;
                                }
                            });
						// obj.translateY(35)
						// obj.translateZ(-50);
						scene.add( obj );
						populateElements(obj);
						drawChart();
						},

					// onProgress callback
					function ( xhr ) {
						console.log( (xhr.loaded / xhr.total * 100) + '% loaded' );
					},

					// onError callback
					function ( err ) {
						console.error( 'An error happened' );
					}
				);

				document.body.onresize = function()
				{
					renderer.setPixelRatio(window.devicePixelRatio + 8);
					drawChart();
				}
				document.body.onresize();
			};

		var bim = document.getElementById("bim");
        bim.addEventListener('change',function() {
            scene.getObjectByName("BIM").visible = !scene.getObjectByName("BIM").visible;
        });

		</script>


{% endblock content %}


